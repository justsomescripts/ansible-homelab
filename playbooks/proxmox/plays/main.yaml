---
# Initialize new Proxmox instance using root user (idempotent)

- name: Proxmox Virtual Environment
  hosts: proxmox
  vars_files:
    - ../vars/main.yaml
  remote_user: "{{ remote_user_configuration__admin.user }}"

  tasks:

    - name: Ensure default packages are present
      ansible.builtin.apt:
        name: "{{ linux__packages }}"
        update_cache: true
      become: true

    - name: Configure SSH admin user
      ansible.builtin.import_role:
        name: remote_user_configuration
      notify:
        - restart_sshd

    - name: Configure Chrony
      ansible.builtin.import_role:
        name: chrony_configuration
      notify:
        - restart_chrony

  handlers:

    - name: Restart sshd after initialization
      ansible.builtin.systemd_service:
        state: restarted
        name: chrony
      become: true
      listen:
        - restart_chrony

    - name: Restart sshd after initialization
      ansible.builtin.systemd_service:
        state: restarted
        name: sshd
      become: true
      listen:
        - restart_sshd
